---
// src/pages/dashboard.astro
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import Navbar from '../components/Navbar.astro';
import '../styles/global.css';

// 1. Verificação de Segurança
const { data: { user } } = await supabase.auth.getUser();
if (!user) return Astro.redirect('/login');

const { data: userProfile } = await supabase.from('profiles').select('role, nome').eq('id', user.id).single();

const userData = {
  ...user,
  profile: userProfile || { role: 'visitante', nome: 'Usuário' }
};

const userName = userProfile?.nome || 'Usuário';
const rawRole = userProfile?.role || 'visitante';
const userRole = String(rawRole).toLowerCase().replace('_', ' ').trim();
const currentPath = Astro.url.pathname;

const masterRoles = ['admin', 'super admin'];
const canSeeItens = masterRoles.includes(userRole) || userRole.includes('estoquista');

// 2. Dados
const now = new Date();
const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();

const { data: movimentacoesMes } = await supabase.from('movimentacoes').select('tipo, quantidade').gte('data_movimentacao', startOfMonth);

let entradasMes = 0;
let saidasMes = 0;
if (movimentacoesMes) {
  movimentacoesMes.forEach(m => {
    if (m.tipo === 'entrada') entradasMes += m.quantidade;
    if (m.tipo === 'saida') saidasMes += m.quantidade;
  });
}
const totalMovimentacoes = entradasMes + saidasMes;
const pctEntrada = totalMovimentacoes > 0 ? (entradasMes / totalMovimentacoes) * 100 : 0;

const { data: historicoRecente, error: histError } = await supabase
  .from('movimentacoes')
  .select(`id, tipo, quantidade, data_movimentacao, motivo, produto:produtos!movimentacoes_produto_id_fkey (nome)`)
  .order('data_movimentacao', { ascending: false })
  .limit(10);

if (histError) console.error(histError);

const { data: produtosSaude } = await supabase.from('produtos').select('id, nome, estoque_atual, estoque_minimo, ativo').eq('ativo', true);
const produtosZerados = produtosSaude?.filter(p => p.estoque_atual === 0).length || 0;
const produtosBaixo = produtosSaude?.filter(p => p.estoque_atual > 0 && p.estoque_atual <= p.estoque_minimo).length || 0;
const produtosOk = (produtosSaude?.length || 0) - produtosZerados - produtosBaixo;
const totalProdutos = produtosSaude?.length || 0;

const { count: totalClientes } = await supabase.from('clientes').select('*', { count: 'exact', head: true });

// Função de estilo atualizada para garantir cores no texto e borda, mas o ícone será forçado no HTML
function getTipoMovimentacao(tipo) {
  if (tipo === 'entrada') return { color: 'text-green-700', bg: 'bg-green-100', border: 'border-green-200' };
  return { color: 'text-red-700', bg: 'bg-red-100', border: 'border-red-200' };
}

function formatDate(dateString) {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
}
---

<Layout title="Dashboard" user={userData}>
  <div class="min-h-screen bg-gray-50 flex flex-col">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 px-6 py-3 shadow-sm">
      <div class="max-w-7xl mx-auto w-full flex items-center justify-between">
        <div class="flex-shrink-0 mr-6">
            <img src="https://i.ibb.co/1Gvrbvk7/ESTOQUE.png" alt="Logo" class="h-16 w-auto" />
        </div>
        <div class="flex-grow flex justify-center">
            <Navbar user={userData} currentPath={currentPath} />
        </div>
        <div class="relative ml-6" id="profile-menu-container">
            <button id="profile-menu-button" class="flex items-center gap-3 focus:outline-none hover:bg-gray-50 p-2 rounded-xl transition-colors">
                <div class="text-right hidden md:block">
                    <p class="text-sm font-bold text-gray-800">{userName}</p>
                    <p class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full uppercase tracking-wide border border-blue-100">
                        {userRole}
                    </p>
                </div>
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg text-lg uppercase">
                    {userName.charAt(0)}
                </div>
            </button>
            <div id="profile-menu-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 z-50">
                <div class="p-4 border-b border-gray-100 bg-gray-50/50 rounded-t-xl">
                    <p class="text-sm font-medium text-gray-900">{userName}</p>
                    <p class="text-xs text-gray-500 truncate">{user.email}</p>
                </div>
                <div class="p-2">
                    <form action="/api/auth/signout" method="POST">
                        <button class="w-full flex items-center gap-2 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors">Sair</button>
                    </form>
                </div>
            </div>
        </div>
      </div>
    </header>

    <main class="p-6 max-w-7xl mx-auto w-full space-y-8">

      <div class="bg-gradient-to-r from-blue-700 to-indigo-800 rounded-2xl p-8 text-white shadow-xl relative overflow-hidden">
        <div class="relative z-10">
          <h2 class="text-3xl font-bold mb-2">Painel Geral</h2>
          <p class="text-blue-100 text-lg">
            Olá, {userName}. 
            {produtosZerados > 0 ? (
                <span>Atenção: Existem <strong class="bg-red-500/20 px-2 py-0.5 rounded text-white border border-red-400/30">{produtosZerados} produtos sem estoque</strong>.</span>
            ) : (
                <span>Seu estoque está operando normalmente.</span>
            )}
          </p>
        </div>
        <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-white/10 to-transparent skew-x-12"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col justify-between min-h-[180px]">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Fluxo Mensal (Atual)</h3>
            <div class="flex items-center justify-between gap-2">
                
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 flex-shrink-0 bg-green-100 text-green-700 rounded-xl flex items-center justify-center border border-green-200">
                        <svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Entradas</p>
                        <p class="text-2xl font-bold text-gray-900">+{entradasMes}</p>
                    </div>
                </div>

                <div class="h-10 w-px bg-gray-100 mx-2"></div>

                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 flex-shrink-0 bg-red-100 text-red-700 rounded-xl flex items-center justify-center border border-red-200">
                        <svg class="w-6 h-6 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Saídas</p>
                        <p class="text-2xl font-bold text-gray-900">-{saidasMes}</p>
                    </div>
                </div>

            </div>
            <div class="mt-4 w-full bg-red-100 rounded-full h-2 overflow-hidden flex">
                <div class="bg-green-500 h-full transition-all duration-500" style={`width: ${pctEntrada}%`}></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col justify-between min-h-[180px]">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Saúde do Estoque</h3>
            <div class="space-y-2 flex-1">
                <div class="flex justify-between text-sm items-center">
                    <span class="flex items-center gap-2 text-gray-600"><span class="w-2 h-2 rounded-full bg-green-500"></span> Normal</span>
                    <span class="font-bold">{produtosOk}</span>
                </div>
                <div class="flex justify-between text-sm items-center">
                    <span class="flex items-center gap-2 text-gray-600"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> Baixo</span>
                    <span class="font-bold text-yellow-600">{produtosBaixo}</span>
                </div>
                <div class="flex justify-between text-sm items-center">
                    <span class="flex items-center gap-2 text-gray-600"><span class="w-2 h-2 rounded-full bg-red-500"></span> Zerado</span>
                    <span class="font-bold text-red-600">{produtosZerados}</span>
                </div>
            </div>
            <div class="mt-4 flex h-2 w-full rounded-full overflow-hidden bg-gray-100">
                <div class="bg-green-500" style={`width: ${(produtosOk/totalProdutos)*100}%`}></div>
                <div class="bg-yellow-500" style={`width: ${(produtosBaixo/totalProdutos)*100}%`}></div>
                <div class="bg-red-500" style={`width: ${(produtosZerados/totalProdutos)*100}%`}></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col justify-between min-h-[180px]">
            <div>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Base de Dados</h3>
                <div class="flex items-center justify-between mt-4">
                    <div>
                        <p class="text-3xl font-bold text-gray-900">{totalProdutos}</p>
                        <p class="text-xs text-gray-500 font-medium">PRODUTOS</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-gray-700">{totalClientes || 0}</p>
                        <p class="text-xs text-gray-500 font-medium">CLIENTES</p>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-50 flex justify-end">
                {canSeeItens ? (
                    <a href="/itens" class="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 group px-3 py-2 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                        GERENCIAR CATÁLOGO 
                        <svg class="w-3 h-3 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
                    </a>
                ) : (
                    <span class="text-xs text-gray-400 cursor-not-allowed flex items-center gap-1">Acesso Restrito</span>
                )}
            </div>
        </div>

      </div>

      <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-800">Atividade Recente</h3>
            <span class="text-xs text-gray-500 bg-white border px-2 py-1 rounded">Últimos 10 registros</span>
        </div>

        <div class="divide-y divide-gray-100">
            {historicoRecente && historicoRecente.length > 0 ? (
                historicoRecente.map((mov) => {
                    const style = getTipoMovimentacao(mov.tipo);
                    const produtoInfo = mov.produto;
                    const nomeProduto = produtoInfo ? (Array.isArray(produtoInfo) ? produtoInfo[0]?.nome : produtoInfo.nome) : 'Produto Removido';

                    return (
                        <div class="p-4 hover:bg-gray-50 transition-colors flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class={`w-10 h-10 min-w-[2.5rem] flex-shrink-0 rounded-full flex items-center justify-center border ${style.bg} ${style.border}`}>
                                    {mov.tipo === 'entrada' ? (
                                        <svg class="w-5 h-5 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                                        </svg>
                                    ) : (
                                        <svg class="w-5 h-5 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                                        </svg>
                                    )}
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-900">{nomeProduto}</p>
                                    <p class="text-xs text-gray-500 flex items-center gap-2 mt-0.5">
                                        <span class="font-mono">{formatDate(mov.data_movimentacao)}</span>
                                        <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                                        <span>{mov.motivo || (mov.tipo === 'entrada' ? 'Entrada Manual' : 'Saída Manual')}</span>
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class={`font-mono font-bold text-sm ${style.color}`}>
                                    {mov.tipo === 'entrada' ? '+' : '-'}{mov.quantidade}
                                </span>
                                <span class={`block text-[10px] uppercase font-bold tracking-wider ${style.color} opacity-70`}>
                                    {mov.tipo}
                                </span>
                            </div>
                        </div>
                    );
                })
            ) : (
                <div class="p-12 text-center flex flex-col items-center justify-center text-gray-400">
                    <svg class="w-12 h-12 mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <p class="text-sm font-medium">Nenhuma movimentação registrada.</p>
                </div>
            )}
        </div>
      </div>

    </main>
  </div>

  <script>
    const menuBtn = document.getElementById('profile-menu-button');
    const menuDropdown = document.getElementById('profile-menu-dropdown');
    const menuContainer = document.getElementById('profile-menu-container');

    if (menuBtn && menuDropdown) {
        menuBtn.addEventListener('click', (e) => { e.stopPropagation(); menuDropdown.classList.toggle('hidden'); });
        document.addEventListener('click', (event) => {
            if (menuContainer && !menuContainer.contains(event.target)) { menuDropdown.classList.add('hidden'); }
        });
    }
  </script>
</Layout>