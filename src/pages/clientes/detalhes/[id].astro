---
// src/pages/itens/detalhes/[id].astro
import Layout from '../../../layouts/Layout.astro';
import { supabase } from '../../../lib/supabase';

const user = Astro.locals.user;
const { id } = Astro.params;

if (!user) {
  return Astro.redirect('/login');
}

// --- LÓGICA DE PERMISSÕES (PARA O HEADER) ---
const userName = user.profile?.name ?? 'Usuário';
const userRole = user.profile?.role ?? 'Visitante';
const userAvatar = userName.charAt(0).toUpperCase() || '#';
const canSeeItens = ['Administrador', 'Estoquista_Entrada', 'Estoquista_Saida'].includes(userRole);
const canSeeClientes = ['Administrador', 'Estoquista_Saida', 'Estoquista_Entrada'].includes(userRole);
const canSeeEntrada = ['Administrador', 'Estoquista_Entrada'].includes(userRole);
const canSeeSaida = ['Administrador', 'Estoquista_Saida'].includes(userRole);
const canSeeRelatorios = ['Administrador'].includes(userRole);
const canSeeImportacao = ['Administrador'].includes(userRole);
const canSeeConfig = ['Administrador'].includes(userRole);

// --- BUSCA DE DADOS ---
// 1. Buscar produto específico com informações do cliente
const { data: produto, error } = await supabase
  .from('produtos')
  .select(`
    *,
    clientes(id, nome, cnpj, email, telefone)
  `)
  .eq('id', id)
  .single();

// 2. Buscar histórico de movimentações
const { data: movimentacoes } = await supabase
  .from('movimentacoes')
  .select(`
    *,
    clientes(nome)
  `)
  .eq('produto_id', id)
  .order('data_movimentacao', { ascending: false })
  .limit(20);

if (!produto) {
  return Astro.redirect('/itens?error=produto_nao_encontrado');
}

// 3. Função para status
function getStatus(stock: number, minStock: number) {
  if (stock === 0) return { 
    text: 'Sem Estoque', 
    color: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-red-600 bg-red-50' 
  };
  if (stock <= minStock) return { 
    text: 'Estoque Baixo', 
    color: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-yellow-600 bg-yellow-50' 
  };
  return { 
    text: 'Em Estoque', 
    color: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-green-600 bg-green-50' 
  };
}
---

<Layout title={`${produto.nome} - Detalhes`} user={user}>
  <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
        <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50">
      <div class="px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-8">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
            	EstoquePro
          	</h1>
          	<nav class="flex items-center gap-1 bg-white/50 rounded-2xl border border-gray-200 p-1 shadow-sm">
          	  <a href="/dashboard" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-50 font-medium text-sm transition-all duration-300">
          	    <span>Dashboard</span>
          	  </a>
          	  {canSeeItens && (
              <a href="/itens" class="px-4 py-2 rounded-xl bg-blue-50 text-blue-600 font-medium text-sm transition-all duration-300">
          	      <span>Itens</span>
        	      </a>
            )}
            {canSeeClientes && (
          	    <a href="/clientes" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-50 font-medium text-sm transition-all duration-300">
          	      <span>Clientes</span>
        	      </a>
            )}
            {canSeeEntrada && (
          	    <a href="/entrada" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-50 font-medium text-sm transition-all duration-300">
          	      <span>Entrada</span>
        	      </a>
            )}
            {canSeeSaida && (
          	    <a href="/saida" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-50 font-medium text-sm transition-all duration-300">
          	      <span>Saída</span>
        	      </a>
            )}
            {canSeeRelatorios && (
          	    <a href="/relatorios" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-50 font-medium text-sm transition-all duration-300">
          	      <span>Relatórios</span>
        	      </a>
            )}
            {canSeeImportacao && (
          	    <a href="/importacao" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-50 font-medium text-sm transition-all duration-300">
          	      <span>Importação</span>
        	      </a>
            )}
            {canSeeConfig && (
              <a href="/config/usuarios" class="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-50 font-medium text-sm transition-all duration-300">
                <span>Configurações</span>
              </a>
            )}
          	</nav>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
              <span class="text-white text-sm font-medium">
                {userAvatar}
              </span>
            </div>
          	<a href="/api/auth/signout" class="relative p-2 text-gray-600 hover:bg-gray-100 rounded-xl transition-colors" title="Sair">
          	  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
        	  </a>
          </div>
        </div>
      </div>
    </header>

        <main class="p-6">
      <div class="max-w-7xl mx-auto">
                <nav class="flex mb-6" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2">
  	        <li>
  	          <a href="/itens" class="text-gray-500 hover:text-gray-700">Produtos</a>
  	        </li>
  	        <li>
  	          <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
  	            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
  	          </svg>
  	        </li>
  	        <li>
  	          <span class="text-gray-700 font-medium">{produto.nome}</span>
  	        </li>
  	      </ol>
    	  </nav>

    	  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    	      	    <div class="lg:col-span-2 space-y-6">
  	        	      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
  	        <div class="flex items-center justify-between mb-6">
  	          <h2 class="text-2xl font-bold text-gray-900">{produto.nome}</h2>
  	          <div class="flex gap-2">
  	            <a href={`/itens/editar/${produto.id}`} class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
  	              Editar
  	            </a>
  	            <a href="/entrada" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
  	              Entrada
  	            </a>
  	            <a href="/saida" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
  	              Saída
  	            </a>
  	          </div>
  	        </div>

  	        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  	          <div>
  	            <h3 class="text-sm font-medium text-gray-500 mb-4">Informações Básicas</h3>
  	            <dl class="space-y-3">
  	              <div>
  	                <dt class="text-sm font-medium text-gray-600">Descrição</dt>
  	                <dd class="text-sm text-gray-900">{produto.descricao || 'Não informada'}</dd>
  	              </div>
  	              <div>
  	                <dt class="text-sm font-medium text-gray-600">Categoria</dt>
  	                <dd class="text-sm text-gray-900">{produto.categoria}</dd>
  	              </div>
  	              <div>
  	                <dt class="text-sm font-medium text-gray-600">Código de Barras</dt>
  	                <dd class="text-sm text-gray-900">{produto.codigo_barras || 'Não informado'}</dd>
  	              </div>
  	              {produto.localizacao && (
  	                <div>
  	                  <dt class="text-sm font-medium text-gray-600">Localização</dt>
  	                  <dd class="text-sm text-gray-900">{produto.localizacao}</dd>
  	                </div>
  	              )}
  	            </dl>
  	          </div>

  	          <div>
  	            <h3 class="text-sm font-medium text-gray-500 mb-4">Estoque e Preços</h3>
  	            <dl class="space-y-3">
  	              <div>
  	                <dt class="text-sm font-medium text-gray-600">Estoque Atual</dt>
  	                <dd class="text-lg font-bold text-gray-900">{produto.estoque_atual} {produto.unidade_medida}</dd>
  	              </div>
  	              <div>
  	                <dt class="text-sm font-medium text-gray-600">Estoque Mínimo</dt>
  	                <dd class="text-sm text-gray-900">{produto.estoque_minimo} {produto.unidade_medida}</dd>
  	              </div>
  	              <div>
  	                <dt class="text-sm font-medium text-gray-600">Preço de Custo</dt>
  	                <dd class="text-sm font-medium text-gray-900">
  	                  R$ {produto.preco_custo?.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) || '0,00'}
  	                </dd>
  	              </div>
  	              <div>
  	                <dt class="text-sm font-medium text-gray-600">Preço de Venda</dt>
  	                <dd class="text-lg font-bold text-green-600">
  	                  R$ {produto.preco_venda?.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) || '0,00'}
  	                </dd>
  	              </div>
  	            </dl>
  	          </div>
  	        </div>

  	        {produto.observacoes && (
  	          <div class="mt-6">
  	            <h3 class="text-sm font-medium text-gray-500 mb-2">Observações</h3>
  	            <p class="text-sm text-gray-900">{produto.observacoes}</p>
  	          </div>
  	        )}
  	      </div>

  	        	      <div class="bg-white rounded-2xl shadow-sm border border-gray-200">
  	        <div class="p-6 border-b border-gray-200">
  	          <h3 class="text-lg font-semibold text-gray-900">Histórico de Movimentações</h3>
  	        </div>
  	        <div class="overflow-x-auto">
  	          <table class="w-full">
  	            <thead>
  	              <tr class="border-b border-gray-200">
  	                <th class="text-left py-4 px-6 text-sm font-medium text-gray-600">Data</th>
  	                <th class="text-left py-4 px-6 text-sm font-medium text-gray-600">Tipo</th>
  	                <th class="text-left py-4 px-6 text-sm font-medium text-gray-600">Qtd.</th>
  	                <th class="text-left py-4 px-6 text-sm font-medium text-gray-600">Valor Unit.</th>
  	                <th class="text-left py-4 px-6 text-sm font-medium text-gray-600">Motivo/Cliente</th>
  	              </tr>
  	            </thead>
  	            <tbody>
  	              {movimentacoes && movimentacoes.length > 0 ? movimentacoes.map((mov) => (
  	                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
  	                  <td class="py-4 px-6 text-sm text-gray-600">
  	                    {new Date(mov.data_movimentacao).toLocaleDateString('pt-BR')}
  	                  </td>
  	                  <td class="py-4 px-6">
  	                    <span class={
  	                      mov.tipo === 'entrada' 
  	                        ? "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-green-600 bg-green-50"
  	                        : "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-red-600 bg-red-50"
  	                    }>
  	                      {mov.tipo === 'entrada' ? 'Entrada' : 'Saída'}
  	                    </span>
  	                  </td>
  	                  <td class="py-4 px-6 text-sm font-medium text-gray-900">
  	                    {mov.quantidade}
  	                  </td>
  	                  <td class="py-4 px-6 text-sm text-gray-600">
  	                    R$ {mov.valor_unitario?.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) || '0,00'}
  	                  </td>
  	                  <td class="py-4 px-6 text-sm text-gray-600">
  	                    {mov.clientes?.nome || mov.motivo || 'N/A'}
  	                  </td>
  	                </tr>
  	              )) : (
  	                <tr>
  	                  <td colspan="5" class="py-8 px-6 text-center text-gray-500">
  	                    Nenhuma movimentação encontrada
  	                  </td>
  	                </tr>
  	              )}
  	            </tbody>
  	          </table>
  	        </div>
  	      </div>
  	    </div>

  	      	    <div class="space-y-6">
  	      {produto.clientes ? (
  	        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
  	          <h3 class="text-lg font-semibold text-gray-900 mb-4">Cliente Associado</h3>
  	          <div class="space-y-3">
  	            <div>
  	              <p class="text-sm font-medium text-gray-600">Nome</p>
  	              <p class="text-sm text-gray-900">{produto.clientes.nome}</p>
  	            </div>
  	            <div>
  	              <p class="text-sm font-medium text-gray-600">CNPJ</p>
  	              <p class="text-sm text-gray-900">{produto.clientes.cnpj}</p>
  	            </div>
  	            {produto.clientes.email && (
  	              <div>
  	                <p class="text-sm font-medium text-gray-600">Email</p>
  	                <p class="text-sm text-gray-900">{produto.clientes.email}</p>
  	              </div>
  	            )}
  	            <a href={`/clientes/detalhes/${produto.clientes.id}`} class="block text-center bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">
  	              Ver Cliente
  	            </a>
  	          </div>
  	        </div>
  	      ) : (
  	        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
  	          <h3 class="text-lg font-semibold text-gray-900 mb-4">Cliente</h3>
  	          <p class="text-sm text-gray-500 mb-4">Este produto não está associado a nenhum cliente.</p>
  	          <a href={`/itens/editar/${produto.id}`} class="block text-center bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">
  	            Associar Cliente
  	          </a>
  	        </div>
  	      )}

  	        	      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
  	        <h3 class="text-lg font-semibold text-gray-900 mb-4">Estatísticas</h3>
  	        <div class="space-y-3">
  	          <div class="flex justify-between">
  	            <span class="text-sm text-gray-600">Valor em Estoque</span>
  	            <span class="text-sm font-medium text-gray-900">
  	              R$ {(produto.estoque_atual * (produto.preco_custo || 0)).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
  	            </span>
  	          </div>
  	          <div class="flex justify-between">
  	            <span class="text-sm text-gray-600">Margem de Lucro</span>
  	            <span class="text-sm font-medium text-green-600">
  	              {produto.preco_custo > 0 && produto.preco_venda > 0 ? 
  	                (((produto.preco_venda - produto.preco_custo) / produto.preco_custo) * 100).toFixed(1) + '%' 
  	                : '0%'
  	              }
  	            </span>
  	          </div>
  	          <div class="flex justify-between">
  	            <span class="text-sm text-gray-600">Status</span>
  	            <span class={getStatus(produto.estoque_atual, produto.estoque_minimo).color}>
  	              {getStatus(produto.estoque_atual, produto.estoque_minimo).text}
  	            </span>
  	          </div>
  	        </div>
  	      </div>
  	    </div>
  	  </div>
  	</div>
  </main>
</div>
</Layout>