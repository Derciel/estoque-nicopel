---
// src/pages/config/editar-usuario/[id].astro
import Layout from '../../../layouts/Layout.astro';
import { supabase } from '../../../lib/supabase';

export const prerender = false;

const user = Astro.locals.user;
const { id: userIdToEdit } = Astro.params; // ID do usuário que vamos editar

// 1. Apenas Admins podem ver esta página
if (user?.profile?.role !== 'admin') {
  return Astro.redirect('/dashboard?error=nao_autorizado');
}

let errorMessage: string | null = null;

// --- LÓGICA DE POST (Atualizar Função) ---
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const newRole = formData.get('new_role')?.toString();
    const userId = formData.get('user_id')?.toString(); // ID do usuário sendo editado

    if (!newRole || !userId) {
      throw new Error('Função ou ID de usuário inválido.');
    }
    
    // 2. Chama a função SQL 'update_user_role' que criamos
    const { error } = await supabase.rpc('update_user_role', {
      user_id_to_update: userId,
      new_role: newRole
    });

    if (error) {
      throw error; // Joga o erro do Supabase
    }

    // 3. Sucesso! Redireciona de volta para a lista
    return Astro.redirect('/config/usuarios?success=Permissões atualizadas!');

  } catch (error: any) {
    console.error('Erro ao atualizar função:', error.message);
    errorMessage = `Erro ao salvar: ${error.message}`;
  }
}

// --- LÓGICA DE GET (Carregar Dados) ---
// Buscar o perfil do usuário que estamos editando
const { data: editedUser, error } = await supabase
  .from('profiles')
  .select('id, nome, email, role')
  .eq('id', userIdToEdit)
  .single();

if (!editedUser) {
  return Astro.redirect('/config/usuarios?error=usuario_nao_encontrado');
}

// Lista de todas as funções possíveis no sistema
const allRoles = ['Administrador', 'Estoquista_Entrada', 'Estoquista_Saida', 'Visitante'];
---

<Layout title={`Editar ${editedUser.nome}`} user={user}>
  <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50">
      </header>

    <main class="p-6">
      <div class="max-w-2xl mx-auto">
        
        <nav class="flex mb-6" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2">
            <li>
              <a href="/config/usuarios" class="text-gray-500 hover:text-gray-700">Usuários</a>
            </li>
            <li>
              <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
            </li>
            <li>
              <span class="text-gray-700 font-medium">Editar Permissões</span>
            </li>
          </ol>
        </nav>

        {errorMessage && (
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
            <strong class="font-bold">Ops! </strong>
            <span class="block sm:inline">{errorMessage}</span>
          </div>
        )}

        <form method="POST" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 space-y-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Editar Usuário</h2>
          
          <input type="hidden" name="user_id" value={editedUser.id} />

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
            <input 
              type="text" 
              value={editedUser.nome || 'N/A'} 
              readonly 
              class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100 text-gray-500"
            >
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input 
              type="email" 
              value={editedUser.email || 'N/A'} 
              readonly 
              class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100 text-gray-500"
            >
          </div>
          
          <div>
            <label for="new_role" class="block text-sm font-medium text-gray-700 mb-1">Permissão (Função) <span class="text-red-500">*</span></label>
            <select 
              name="new_role" 
              id="new_role" 
              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              {allRoles.map(role => (
                <option value={role} selected={role === editedUser.role}>
                  {role}
                </option>
              ))}
            </select>
          </div>
          
          <div class="flex items-center justify-end gap-4 mt-8 pt-6 border-t border-gray-200">
            <a href="/config/usuarios" class="bg-gray-100 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-200 transition-colors font-medium">
              Cancelar
            </a>
            <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors font-medium">
              Salvar Permissões
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>
</Layout>