---
// src/pages/config/editar-usuario/[id].astro
import Layout from '../../../layouts/Layout.astro';
import Navbar from '../../../components/Navbar.astro';
import { supabase } from '$/lib/supabase'; // Para checar quem está logado
import { supabaseAdmin } from '../../../lib/supabase-admin'; // Para editar os dados

export const prerender = false;

// 1. VERIFICAÇÃO DE SEGURANÇA (Quem está acessando?)
const { data: { user }, error: authError } = await supabase.auth.getUser();

if (authError || !user) {
  return Astro.redirect('/login');
}

// Verifica se o usuário atual é ADMIN
const { data: currentUserProfile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single();

if (currentUserProfile?.role !== 'admin') {
  return Astro.redirect('/dashboard?error=acesso_negado');
}

const currentPath = Astro.url.pathname;
const { id: userIdToEdit } = Astro.params;

let errorMessage: string | null = null;

// --- LÓGICA DE POST (Salvar Edição) ---
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const newRole = formData.get('new_role')?.toString();
    const newName = formData.get('new_name')?.toString();
    const userId = formData.get('user_id')?.toString();

    if (!newRole || !userId || !newName) {
      throw new Error('Dados inválidos para atualização.');
    }
    
    // 2. ATUALIZAR VIA ADMIN (Blindado)
    
    // A) Atualiza metadados do Auth (Login)
    const { error: authUpdateError } = await supabaseAdmin.auth.admin.updateUserById(
      userId, 
      { user_metadata: { role: newRole, nome: newName } }
    );
    if (authUpdateError) throw authUpdateError;

    // B) Atualiza tabela Profiles (Dados do Sistema)
    const { error: profileUpdateError } = await supabaseAdmin
      .from('profiles')
      .update({ role: newRole, nome: newName })
      .eq('id', userId);

    if (profileUpdateError) throw profileUpdateError;

    // 3. Sucesso!
    return Astro.redirect('/config/usuarios?success=Usuário atualizado com sucesso!');

  } catch (error: any) {
    console.error('Erro ao atualizar:', error.message);
    errorMessage = `Erro ao salvar: ${error.message}`;
  }
}

// --- LÓGICA DE GET (Carregar Dados do Usuário Alvo) ---
// Usamos supabaseAdmin para garantir que vamos achar o usuário, mesmo se o RLS estiver restritivo
const { data: editedUser, error: fetchError } = await supabaseAdmin
  .from('profiles')
  .select('id, nome, email, role')
  .eq('id', userIdToEdit)
  .single();

if (fetchError || !editedUser) {
  return Astro.redirect('/config/usuarios?error=usuario_nao_encontrado');
}

// Lista de funções (Values devem ser iguais aos do banco, Labels para exibição)
const roles = [
    { value: 'admin', label: 'Administrador' },
    { value: 'estoquista_entrada', label: 'Estoquista Entrada (Compras)' },
    { value: 'estoquista_saida', label: 'Estoquista Saída (Vendas)' },
    { value: 'visualizador', label: 'Visualizador (Apenas Leitura)' }
];
---

<Layout title={`Editar ${editedUser.nome}`} user={user}>
  <div class="min-h-screen bg-gray-50 flex flex-col">
    
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 px-6 py-4">
      <div class="max-w-7xl mx-auto w-full flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            Editar Usuário
        </h1>
        <Navbar user={user} currentPath={currentPath} />
      </div>
    </header>

    <main class="p-6 max-w-7xl mx-auto w-full">
      <div class="max-w-2xl mx-auto">
        
        <nav class="flex mb-6" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2">
            <li>
              <a href="/config/usuarios" class="text-gray-500 hover:text-blue-600 transition-colors">Usuários</a>
            </li>
            <li>
              <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
            </li>
            <li>
              <span class="text-gray-700 font-medium">Editando: {editedUser.nome}</span>
            </li>
          </ol>
        </nav>

        {errorMessage && (
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6 shadow-sm">
            <strong class="font-bold">Erro: </strong>
            <span class="block sm:inline">{errorMessage}</span>
          </div>
        )}

        <form method="POST" class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 space-y-6">
          
          <input type="hidden" name="user_id" value={editedUser.id} />

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email (Não editável)</label>
            <input 
              type="email" 
              value={editedUser.email || 'Email não disponível'} 
              readonly 
              class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100 text-gray-500 cursor-not-allowed"
            >
            <p class="text-xs text-gray-400 mt-1">Para alterar o email, crie um novo usuário e exclua este.</p>
          </div>

          <div>
            <label for="new_name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
            <input 
              type="text" 
              name="new_name"
              id="new_name"
              value={editedUser.nome || ''} 
              required
              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            >
          </div>
          
          <div>
            <label for="new_role" class="block text-sm font-medium text-gray-700 mb-1">Permissão (Função) <span class="text-red-500">*</span></label>
            <select 
              name="new_role" 
              id="new_role" 
              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white transition-all"
            >
              {roles.map(r => (
                <option value={r.value} selected={r.value === editedUser.role}>
                  {r.label}
                </option>
              ))}
            </select>
          </div>
          
          <div class="flex items-center justify-end gap-4 mt-8 pt-6 border-t border-gray-200">
            <a href="/config/usuarios" class="bg-white border border-gray-300 text-gray-700 px-6 py-2.5 rounded-lg hover:bg-gray-50 transition-colors font-medium">
              Cancelar
            </a>
            <button type="submit" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-sm hover:shadow">
              Salvar Alterações
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>
</Layout>