---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

const user = Astro.locals.user;
if (!user) return Astro.redirect('/login');

const currentPath = Astro.url.pathname;
const userRole = user.profile?.role ?? 'Visitante';
const canSeeRelatorios = ['admin', 'Administrador'].includes(userRole);

if (!canSeeRelatorios) return Astro.redirect('/dashboard?error=sem_permissao');

// ✅ Busca movimentações
const { data: movimentacoes, error: movError } = await supabase
  .from('movimentacoes')
  .select('*')
  .order('data_movimentacao', { ascending: false });

if (movError) console.error('Erro ao buscar movimentações:', movError);

// ✅ Busca produtos (para mapear nomes)
const { data: produtos } = await supabase
  .from('produtos')
  .select('id, nome, categoria');

const produtosMap = {};
if (produtos) {
  produtos.forEach(p => {
    produtosMap[p.id] = p;
  });
}
---

<Layout title="Relatórios" user={user}>
  <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">

    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50 w-full">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <img src=https://i.ibb.co/1Gvrbvk7/ESTOQUE.png" alt="EstoquePro logo" class="h-20 w-auto mr-4" />
        </h1>
        <nav class="flex items-center gap-2 bg-white/50 rounded-2xl border border-gray-200 p-1 shadow-sm">
          <a href="/dashboard"
            class={`px-4 py-2 rounded-xl text-sm font-medium transition-all ${
              currentPath === '/dashboard' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'
            }`}>Dashboard</a>
          <a href="/relatorios"
            class={`px-4 py-2 rounded-xl text-sm font-medium transition-all ${
              currentPath === '/relatorios' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'
            }`}>Relatórios</a>
        </nav>
      </div>
    </header>

    <main class="p-6">
      <div class="max-w-7xl mx-auto">
        <div class="mb-8">
          <h2 class="text-3xl font-bold text-gray-900">Relatórios de Movimentações</h2>
          <p class="text-gray-600 mt-2">Entradas e saídas do estoque</p>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200">
          <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900">Histórico de Movimentações</h3>
            <div class="flex gap-2">
              <button id="btnPDF" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">PDF</button>
              <button id="btnExcel" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">Excel</button>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="tabela-relatorio">
              <thead>
                <tr class="border-b border-gray-200 bg-gray-50">
                  <th class="py-3 px-6 text-left font-medium text-gray-700">Data</th>
                  <th class="py-3 px-6 text-left font-medium text-gray-700">Produto</th>
                  <th class="py-3 px-6 text-left font-medium text-gray-700">Categoria</th>
                  <th class="py-3 px-6 text-left font-medium text-gray-700">Tipo</th>
                  <th class="py-3 px-6 text-left font-medium text-gray-700">Quantidade</th>
                  <th class="py-3 px-6 text-left font-medium text-gray-700">Motivo</th>
                </tr>
              </thead>
              <tbody>
                {movimentacoes && movimentacoes.length > 0 ? (
                  movimentacoes.map((m) => {
                    const produto = produtosMap[m.produto_id] || {};
                    return (
                      <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
                        <td class="py-3 px-6">{new Date(m.data_movimentacao).toLocaleDateString('pt-BR')}</td>
                        <td class="py-3 px-6 font-medium text-gray-900">{produto.nome || '-'}</td>
                        <td class="py-3 px-6 text-gray-600">{produto.categoria || '-'}</td>
                        <td class="py-3 px-6">
                          <span class={`px-2 py-0.5 rounded-full text-xs font-medium ${
                            m.tipo === 'entrada' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'
                          }`}>
                            {m.tipo}
                          </span>
                        </td>
                        <td class="py-3 px-6 font-medium text-gray-900">{m.quantidade}</td>
                        <td class="py-3 px-6 text-gray-600">{m.motivo || '--'}</td>
                      </tr>
                    );
                  })
                ) : (
                  <tr>
                    <td colspan="6" class="py-6 text-center text-gray-500">Nenhuma movimentação encontrada.</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ✅ Exportação -->
  <script is:inline>
    document.getElementById('btnPDF')?.addEventListener('click', async () => {
      const { jsPDF } = await import('jspdf');
      const doc = new jsPDF();
      doc.text('Relatório de Movimentações - EstoquePro', 10, 10);
      doc.text('Gerado em: ' + new Date().toLocaleString('pt-BR'), 10, 20);
      doc.save('relatorio_estoque.pdf');
    });

    document.getElementById('btnExcel')?.addEventListener('click', async () => {
      const XLSX = await import('xlsx');
      const table = document.getElementById('tabela-relatorio');
      const wb = XLSX.utils.table_to_book(table, { sheet: 'Relatório' });
      XLSX.writeFile(wb, 'relatorio_estoque.xlsx');
    });
  </script>
</Layout>
