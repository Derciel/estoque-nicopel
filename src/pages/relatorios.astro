---
// src/pages/relatorios.astro
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import Navbar from '../components/Navbar.astro';
import '../styles/global.css';

// 1. Seguran칞a e Sess칚o
const { data: { user } } = await supabase.auth.getUser();
if (!user) return Astro.redirect('/login');

const { data: userProfile } = await supabase.from('profiles').select('*').eq('id', user.id).single();

const userData = { ...user, profile: userProfile };
const userName = userProfile?.nome || 'Usu치rio';
const userRole = String(userProfile?.role || 'visitante').toLowerCase().trim();
const userAvatar = userName.charAt(0).toUpperCase();
const currentPath = Astro.url.pathname;

// Permiss칚o
const masterRoles = ['admin', 'super admin'];
if (!masterRoles.includes(userRole)) {
  return Astro.redirect('/dashboard?error=sem_permissao_relatorios');
}

// ==========================================
// 游늵 L칍GICA DE DADOS (INVENT츼RIO ATUAL)
// ==========================================

// 1. Buscar Clientes
const { data: clientes } = await supabase
  .from('clientes')
  .select('*')
  .order('nome');

// 2. Buscar Produtos
const { data: produtos } = await supabase
  .from('produtos')
  .select('*')
  .order('nome');

// 3. Agrupar Dados
const relatorio = clientes?.map(cliente => {
    // Filtra produtos deste cliente
    const produtosDoCliente = produtos?.filter(p => p.cliente_id === cliente.id) || [];
    
    // C치lculos de resumo
    const totalItens = produtosDoCliente.reduce((acc, p) => acc + p.estoque_atual, 0);
    const itensZerados = produtosDoCliente.filter(p => p.estoque_atual === 0).length;
    
    // Fix: Movendo a compara칞칚o para fora do HTML para evitar erro de parser
    const itensBaixo = produtosDoCliente.filter(p => {
        const minimo = p.estoque_minimo || 0;
        return p.estoque_atual > 0 && p.estoque_atual <= minimo;
    }).length;

    return {
        info: cliente,
        produtos: produtosDoCliente,
        resumo: { totalItens, itensZerados, itensBaixo }
    };
}).filter(grupo => grupo.produtos.length > 0); // Remove clientes sem produtos

// 4. Fun칞칫es Auxiliares de Visualiza칞칚o (CORRE칂츾O DO ERRO)
// Movemos a l칩gica de decis칚o de cor/texto para c치 para n칚o usar '<' no HTML
function getStatusBadge(atual, min) {
    if (atual === 0) return { text: 'SEM ESTOQUE', class: 'bg-red-100 text-red-700 border-red-200' };
    if (atual <= min) return { text: 'ESTOQUE BAIXO', class: 'bg-yellow-100 text-yellow-700 border-yellow-200' };
    return { text: 'EM ESTOQUE', class: 'bg-green-100 text-green-700 border-green-200' };
}

function getSituacaoTexto(atual, min) {
    if (atual === 0) return { text: 'Falta Repor', class: 'text-red-600 font-bold' };
    if (atual <= min) return { text: 'Comprar', class: 'text-yellow-600 font-bold' };
    return { text: 'OK', class: 'text-green-600 font-medium' };
}
---

<Layout title="Relat칩rio de Invent치rio" user={userData}>
  <div class="min-h-screen bg-gray-50 flex flex-col">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 px-6 py-3 shadow-sm">
      <div class="max-w-7xl mx-auto w-full flex items-center justify-between">
        <div class="flex-shrink-0 mr-6">
            <img src="https://i.ibb.co/1Gvrbvk7/ESTOQUE.png" alt="Logo" class="h-16 w-auto" />
        </div>
        <div class="flex-grow flex justify-center">
            <Navbar user={userData} currentPath={currentPath} />
        </div>
        <div class="flex-shrink-0 relative group ml-6">
            <button class="flex items-center gap-3 focus:outline-none hover:bg-gray-50 p-2 rounded-xl transition-colors">
                <div class="text-right hidden md:block">
                    <p class="text-sm font-bold text-gray-800">{userName}</p>
                    <p class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full uppercase tracking-wide border border-blue-100">
                        {userRole}
                    </p>
                </div>
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg text-lg uppercase">
                    {userAvatar}
                </div>
            </button>
            <div class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 hidden group-hover:block z-50 animate-fade-in">
                <div class="p-4 border-b border-gray-100 bg-gray-50/50 rounded-t-xl">
                    <p class="text-sm font-medium text-gray-900">{userName}</p>
                    <p class="text-xs text-gray-500 truncate">{user.email}</p>
                </div>
                <div class="p-2">
                    <form action="/api/auth/signout" method="POST">
                        <button class="w-full flex items-center gap-2 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors">Sair</button>
                    </form>
                </div>
            </div>
        </div>
      </div>
    </header>

    <main class="p-6 max-w-7xl mx-auto w-full">
      
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">Relat칩rio de Invent치rio</h2>
          <p class="text-gray-600 mt-1">Posi칞칚o atual do estoque agrupada por cliente.</p>
        </div>
        
        <div class="flex gap-3">
          <button id="btnPDF" class="flex items-center gap-2 bg-red-600 text-white px-5 py-2.5 rounded-xl hover:bg-red-700 transition shadow-sm font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            PDF
          </button>
          <button id="btnExcel" class="flex items-center gap-2 bg-green-600 text-white px-5 py-2.5 rounded-xl hover:bg-green-700 transition shadow-sm font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Excel
          </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left" id="tabela-inventario">
            <thead class="bg-gray-50 text-gray-700 border-b border-gray-200 uppercase text-xs">
              <tr>
                <th class="py-4 px-6">Produto / Categoria</th>
                <th class="py-4 px-6 text-center">Status</th>
                <th class="py-4 px-6 text-right">M칤nimo</th>
                <th class="py-4 px-6 text-right">Atual</th>
                <th class="py-4 px-6 text-right">Situa칞칚o</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {relatorio?.map((grupo) => (
                <>
                  <tr class="bg-blue-50/50 border-t border-b border-blue-100">
                    <td colspan="5" class="py-3 px-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-bold text-lg text-gray-900">{grupo.info.nome}</span>
                                <span class="text-xs text-gray-500 ml-2 font-mono">{grupo.info.cnpj}</span>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span class="px-2 py-1 bg-white border rounded text-gray-600">Total: <strong>{grupo.resumo.totalItens}</strong></span>
                                {grupo.resumo.itensZerados > 0 && <span class="px-2 py-1 bg-red-100 text-red-700 rounded font-bold">Zerados: {grupo.resumo.itensZerados}</span>}
                            </div>
                        </div>
                    </td>
                  </tr>

                  {grupo.produtos.map((prod) => {
                    // Usamos as fun칞칫es criadas l치 em cima para evitar l칩gica complexa no HTML
                    const badge = getStatusBadge(prod.estoque_atual, prod.estoque_minimo);
                    const situacao = getSituacaoTexto(prod.estoque_atual, prod.estoque_minimo);
                    
                    return (
                        <tr class="hover:bg-gray-50 transition">
                            <td class="py-3 px-6">
                                <p class="font-bold text-gray-800">{prod.nome}</p>
                                <p class="text-xs text-gray-500">{prod.categoria}</p>
                            </td>
                            <td class="py-3 px-6 text-center">
                                <span class={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide border ${badge.class}`}>
                                    {badge.text}
                                </span>
                            </td>
                            <td class="py-3 px-6 text-right text-gray-500">{prod.estoque_minimo}</td>
                            <td class="py-3 px-6 text-right font-bold text-gray-900 text-base">{prod.estoque_atual}</td>
                            <td class="py-3 px-6 text-right text-xs">
                                <span class={situacao.class}>{situacao.text}</span>
                            </td>
                        </tr>
                    );
                  })}
                </>
              ))}
              
              {(!relatorio || relatorio.length === 0) && (
                <tr><td colspan="5" class="py-12 text-center text-gray-400">Nenhum produto cadastrado no estoque.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    import { jsPDF } from "jspdf";
    import autoTable from 'jspdf-autotable';
    import * as XLSX from 'xlsx';

    // PDF
    document.getElementById('btnPDF')?.addEventListener('click', () => {
      const doc = new jsPDF();
      doc.text("Relat칩rio de Posi칞칚o de Estoque", 14, 15);
      doc.setFontSize(10);
      doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 22);

      autoTable(doc, {
        html: '#tabela-inventario',
        startY: 30,
        theme: 'grid',
        styles: { fontSize: 8 },
        headStyles: { fillColor: [66, 133, 244] },
        didParseCell: function (data) {
            // Estiliza a linha do Cliente (que tem colspan)
            if (data.row.raw.cells[0].colSpan > 1) {
                data.cell.styles.fillColor = [240, 245, 255]; // Azul claro
                data.cell.styles.fontStyle = 'bold';
                data.cell.styles.textColor = [30, 30, 30];
                data.cell.styles.halign = 'left'; // For칞a alinhamento  esquerda
            }
        }
      });
      doc.save('inventario-estoque.pdf');
    });

    // Excel
    document.getElementById('btnExcel')?.addEventListener('click', () => {
      const table = document.getElementById('tabela-inventario');
      const wb = XLSX.utils.table_to_book(table, { sheet: "Invent치rio" });
      XLSX.writeFile(wb, 'inventario-estoque.xlsx');
    });
  </script>
</Layout>