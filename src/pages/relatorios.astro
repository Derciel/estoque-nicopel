---
// src/pages/relatorios.astro
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import Navbar from '../components/Navbar.astro';
import '../styles/global.css';

// 1. Seguran칞a e Sess칚o
const { data: { user } } = await supabase.auth.getUser();
if (!user) return Astro.redirect('/login');

const { data: userProfile } = await supabase.from('profiles').select('*').eq('id', user.id).single();

const userData = { ...user, profile: userProfile };
const userName = userProfile?.nome || 'Usu치rio';
const userRole = String(userProfile?.role || 'visitante').toLowerCase().trim();
const userAvatar = userName.charAt(0).toUpperCase();
const currentPath = Astro.url.pathname;

// Permiss칚o
const masterRoles = ['admin', 'super admin'];
if (!masterRoles.includes(userRole)) {
  return Astro.redirect('/dashboard?error=sem_permissao_relatorios');
}

// ==========================================
// 游늵 L칍GICA DE DADOS
// ==========================================

const { data: clientes } = await supabase.from('clientes').select('*').order('nome');
const { data: produtos } = await supabase.from('produtos').select('*').order('nome');

const relatorio = clientes?.map(cliente => {
    const produtosDoCliente = produtos?.filter(p => p.cliente_id === cliente.id) || [];
    
    const totalItens = produtosDoCliente.reduce((acc, p) => acc + p.estoque_atual, 0);
    const itensZerados = produtosDoCliente.filter(p => p.estoque_atual === 0).length;
    
    // Filtro de Baixo Estoque
    const itensBaixo = produtosDoCliente.filter(p => {
        const minimo = p.estoque_minimo || 0;
        return p.estoque_atual > 0 && p.estoque_atual <= minimo;
    }).length;

    return {
        info: cliente,
        produtos: produtosDoCliente,
        resumo: { totalItens, itensZerados, itensBaixo }
    };
}).filter(grupo => grupo.produtos.length > 0);

// Fun칞칚o Auxiliar
function getStatusData(atual, min) {
    if (atual === 0) return { key: 'zerado', text: 'SEM ESTOQUE', class: 'bg-red-100 text-red-700 border-red-200' };
    if (atual <= min) return { key: 'baixo', text: 'ESTOQUE BAIXO', class: 'bg-yellow-100 text-yellow-700 border-yellow-200' };
    return { key: 'normal', text: 'EM ESTOQUE', class: 'bg-green-100 text-green-700 border-green-200' };
}

function getSituacaoTexto(atual, min) {
    if (atual === 0) return { text: 'PRODUZIR', class: 'text-red-600 font-bold' };
    if (atual <= min) return { text: 'AGUARDANDO PRODU칂츾O', class: 'text-yellow-600 font-bold' };
    return { text: 'ESTOQUE OK', class: 'text-green-600 font-medium' };
}
---

<Layout title="Relat칩rio de Invent치rio" user={userData}>
  <div class="min-h-screen bg-gray-50 flex flex-col">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 px-6 py-3 shadow-sm">
      <div class="max-w-7xl mx-auto w-full flex items-center justify-between">
        <div class="flex-shrink-0 mr-6">
            <img src="https://i.ibb.co/1Gvrbvk7/ESTOQUE.png" alt="Logo" class="h-16 w-auto" />
        </div>
        <div class="flex-grow flex justify-center">
            <Navbar user={userData} currentPath={currentPath} />
        </div>
        <div class="flex-shrink-0 relative group ml-6">
            <button class="flex items-center gap-3 focus:outline-none hover:bg-gray-50 p-2 rounded-xl transition-colors">
                <div class="text-right hidden md:block">
                    <p class="text-sm font-bold text-gray-800">{userName}</p>
                    <p class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full uppercase tracking-wide border border-blue-100">
                        {userRole}
                    </p>
                </div>
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg text-lg uppercase">
                    {userAvatar}
                </div>
            </button>
            <div class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 hidden group-hover:block z-50 animate-fade-in">
                <div class="p-4 border-b border-gray-100 bg-gray-50/50 rounded-t-xl">
                    <p class="text-sm font-medium text-gray-900">{userName}</p>
                    <p class="text-xs text-gray-500 truncate">{user.email}</p>
                </div>
                <div class="p-2">
                    <form action="/api/auth/signout" method="POST">
                        <button class="w-full flex items-center gap-2 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors">Sair</button>
                    </form>
                </div>
            </div>
        </div>
      </div>
    </header>

    <main class="p-6 max-w-7xl mx-auto w-full">
      
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">Relat칩rio de Invent치rio</h2>
          <p class="text-gray-600 mt-1">Posi칞칚o atual do estoque agrupada por cliente.</p>
        </div>
        
        <div class="flex flex-wrap items-center gap-3">
            
            <a href="/relatorios/detalhado" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2.5 rounded-xl hover:bg-blue-700 transition shadow-sm font-medium text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Por Per칤odo
            </a>

            <div class="h-8 w-px bg-gray-300 mx-1 hidden md:block"></div>

            <div class="relative">
                <select id="filtroStatus" class="appearance-none bg-white border border-gray-300 text-gray-700 py-2.5 pl-4 pr-10 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium shadow-sm cursor-pointer">
                    <option value="todos">游늶 Mostrar Todos</option>
                    <option value="atencao">丘멆잺 Reposi칞칚o (Baixo/Zerado)</option>
                    <option value="zerado">游댮 Apenas Zerados</option>
                    <option value="baixo">游리 Apenas Baixo</option>
                    <option value="normal">游릭 Apenas Normal</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </div>
            </div>

            <div class="h-8 w-px bg-gray-300 mx-1 hidden md:block"></div>

            <button id="btnPDF" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2.5 rounded-xl hover:bg-red-700 transition shadow-sm font-medium text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                PDF
            </button>
            <button id="btnExcel" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2.5 rounded-xl hover:bg-green-700 transition shadow-sm font-medium text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Excel
            </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left" id="tabela-inventario">
            <thead class="bg-gray-50 text-gray-700 border-b border-gray-200 uppercase text-xs">
              <tr>
                <th class="py-4 px-6">Produto / Categoria</th>
                <th class="py-4 px-6 text-center">Status</th>
                <th class="py-4 px-6 text-right">M칤nimo</th>
                <th class="py-4 px-6 text-right">Atual</th>
                <th class="py-4 px-6 text-right">Situa칞칚o</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100" id="tabela-body">
              {relatorio?.map((grupo) => (
                <>
                  <tr class="bg-blue-50/50 border-t border-b border-blue-100 linha-cliente" data-grupo={grupo.info.id}>
                    <td colspan="5" class="py-3 px-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-bold text-lg text-gray-900">{grupo.info.nome}</span>
                                <span class="text-xs text-gray-500 ml-2 font-mono">{grupo.info.cnpj}</span>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span class="px-2 py-1 bg-white border rounded text-gray-600">Total: <strong>{grupo.resumo.totalItens}</strong></span>
                                {grupo.resumo.itensZerados > 0 && <span class="px-2 py-1 bg-red-100 text-red-700 rounded font-bold">Zerados: {grupo.resumo.itensZerados}</span>}
                            </div>
                        </div>
                    </td>
                  </tr>

                  {grupo.produtos.map((prod) => {
                    const statusData = getStatusData(prod.estoque_atual, prod.estoque_minimo);
                    const situacao = getSituacaoTexto(prod.estoque_atual, prod.estoque_minimo);
                    
                    return (
                        <tr class="hover:bg-gray-50 transition linha-produto" data-status={statusData.key} data-pai={grupo.info.id}>
                            <td class="py-3 px-6">
                                <p class="font-bold text-gray-800">{prod.nome}</p>
                                <p class="text-xs text-gray-500">{prod.categoria}</p>
                            </td>
                            <td class="py-3 px-6 text-center">
                                <span class={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide border ${statusData.class}`}>
                                    {statusData.text}
                                </span>
                            </td>
                            <td class="py-3 px-6 text-right text-gray-500">{prod.estoque_minimo}</td>
                            <td class="py-3 px-6 text-right font-bold text-gray-900 text-base">{prod.estoque_atual}</td>
                            <td class="py-3 px-6 text-right text-xs">
                                <span class={situacao.class}>{situacao.text}</span>
                            </td>
                        </tr>
                    );
                  })}
                </>
              ))}
              
              {(!relatorio || relatorio.length === 0) && (
                <tr><td colspan="5" class="py-12 text-center text-gray-400">Nenhum produto cadastrado no estoque.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    import { jsPDF } from "jspdf";
    import autoTable from 'jspdf-autotable';
    import * as XLSX from 'xlsx';

    // --- L칍GICA DE FILTRAGEM ---
    const filtroStatus = document.getElementById('filtroStatus');
    
    filtroStatus?.addEventListener('change', (e) => {
        const filtro = e.target.value; 
        const linhasProduto = document.querySelectorAll('.linha-produto');
        const linhasCliente = document.querySelectorAll('.linha-cliente');

        linhasProduto.forEach(linha => {
            const status = linha.dataset.status; 
            let mostrar = false;

            if (filtro === 'todos') {
                mostrar = true;
            } else if (filtro === 'atencao') {
                if (status === 'zerado' || status === 'baixo') mostrar = true;
            } else {
                if (status === filtro) mostrar = true;
            }

            if (mostrar) linha.classList.remove('hidden');
            else linha.classList.add('hidden');
        });

        linhasCliente.forEach(clienteRow => {
            const idCliente = clienteRow.dataset.grupo;
            const produtosVisiveis = document.querySelectorAll(`.linha-produto[data-pai="${idCliente}"]:not(.hidden)`);
            
            if (produtosVisiveis.length > 0) {
                clienteRow.classList.remove('hidden');
            } else {
                clienteRow.classList.add('hidden');
            }
        });
    });

    // --- PDF ---
    document.getElementById('btnPDF')?.addEventListener('click', () => {
      const doc = new jsPDF();
      doc.text("Relat칩rio de Posi칞칚o de Estoque", 14, 15);
      doc.setFontSize(10);
      doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 22);

      autoTable(doc, {
        html: '#tabela-inventario',
        startY: 30,
        theme: 'grid',
        styles: { fontSize: 8 },
        headStyles: { fillColor: [66, 133, 244] },
        didParseCell: function (data) {
            if (data.row.raw && data.row.raw.classList && data.row.raw.classList.contains('hidden')) {
                data.cell.styles.fontSize = 0;
                data.row.height = 0;
                return;
            }
            if (data.row.raw.cells[0].colSpan > 1) {
                data.cell.styles.fillColor = [240, 245, 255];
                data.cell.styles.fontStyle = 'bold';
                data.cell.styles.textColor = [30, 30, 30];
                data.cell.styles.halign = 'left';
            }
        }
      });
      doc.save('inventario-estoque.pdf');
    });

    // --- Excel ---
    document.getElementById('btnExcel')?.addEventListener('click', () => {
      const table = document.getElementById('tabela-inventario');
      const wb = XLSX.utils.table_to_book(table, { sheet: "Invent치rio" });
      XLSX.writeFile(wb, 'inventario-estoque.xlsx');
    });
  </script>
</Layout>