---
// src/pages/relatorios.astro
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import Navbar from '../components/Navbar.astro';
import '../styles/global.css';

// 1. Seguran√ßa e Sess√£o
const { data: { user } } = await supabase.auth.getUser();
if (!user) return Astro.redirect('/login');

// 2. Perfil e Permiss√µes
const { data: userProfile } = await supabase.from('profiles').select('*').eq('id', user.id).single();

const userData = { ...user, profile: userProfile };
const userName = userProfile?.nome || 'Usu√°rio';
const userRole = String(userProfile?.role || 'visitante').toLowerCase().trim();
const userAvatar = userName.charAt(0).toUpperCase();
const currentPath = Astro.url.pathname;

// Apenas Master pode ver relat√≥rios
const masterRoles = ['admin', 'super admin'];
if (!masterRoles.includes(userRole)) {
  return Astro.redirect('/dashboard?error=sem_permissao_relatorios');
}

// ==========================================
// üìä BUSCA DE DADOS
// ==========================================

// A) Movimenta√ß√µes (Limite de 500 para performance)
const { data: movimentacoes, error: movError } = await supabase
  .from('movimentacoes')
  .select('*')
  .order('data_movimentacao', { ascending: false })
  .limit(500);

if (movError) console.error('Erro Movimenta√ß√µes:', movError);

// B) Produtos (Para pegar os nomes via ID)
const { data: produtos } = await supabase
  .from('produtos')
  .select('id, nome, categoria');

const produtosMap = {};
if (produtos) {
  produtos.forEach(p => { produtosMap[p.id] = p; });
}

// C) Clientes (Para pegar os nomes via ID)
const { data: clientes } = await supabase
  .from('clientes')
  .select('id, nome');

const clientesMap = {};
if (clientes) {
    clientes.forEach(c => { clientesMap[c.id] = c.nome; });
}

// Fun√ß√£o auxiliar de formata√ß√£o
function formatDate(dateString) {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('pt-BR', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
}
---

<Layout title="Relat√≥rios" user={userData}>
  <div class="min-h-screen bg-gray-50 flex flex-col">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 px-6 py-3 shadow-sm">
      <div class="max-w-7xl mx-auto w-full flex items-center justify-between">
        <div class="flex-shrink-0 mr-6">
            <img src="https://i.ibb.co/1Gvrbvk7/ESTOQUE.png" alt="EstoquePro logo" class="h-16 w-auto" />
        </div>
        <div class="flex-grow flex justify-center">
            <Navbar user={userData} currentPath={currentPath} />
        </div>
        <div class="flex-shrink-0 relative group ml-6">
            <button class="flex items-center gap-3 focus:outline-none hover:bg-gray-50 p-2 rounded-xl transition-colors">
                <div class="text-right hidden md:block">
                    <p class="text-sm font-bold text-gray-800">{userName}</p>
                    <p class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full uppercase tracking-wide border border-blue-100">
                        {userRole}
                    </p>
                </div>
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg text-lg uppercase">
                    {userAvatar}
                </div>
            </button>
            <div class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 hidden group-hover:block z-50">
                <div class="p-4 border-b border-gray-100 bg-gray-50/50 rounded-t-xl">
                    <p class="text-sm font-medium text-gray-900">{userName}</p>
                    <p class="text-xs text-gray-500 truncate">{user.email}</p>
                </div>
                <div class="p-2">
                    <form action="/api/auth/signout" method="POST">
                        <button class="w-full flex items-center gap-2 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors">Sair</button>
                    </form>
                </div>
            </div>
        </div>
      </div>
    </header>

    <main class="p-6 max-w-7xl mx-auto w-full">
      
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">Relat√≥rios</h2>
          <p class="text-gray-600 mt-1">Hist√≥rico completo de movimenta√ß√µes do estoque.</p>
        </div>
        
        <div class="flex gap-3">
          <button id="btnPDF" class="flex items-center gap-2 bg-red-600 text-white px-5 py-2.5 rounded-xl hover:bg-red-700 transition shadow-sm font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            Exportar PDF
          </button>
          <button id="btnExcel" class="flex items-center gap-2 bg-green-600 text-white px-5 py-2.5 rounded-xl hover:bg-green-700 transition shadow-sm font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Exportar Excel
          </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left" id="tabela-relatorio">
            <thead class="bg-gray-50 text-gray-700 border-b border-gray-200 uppercase text-xs">
              <tr>
                <th class="py-4 px-6">Data</th>
                <th class="py-4 px-6">Produto</th>
                <th class="py-4 px-6">Cliente</th> <th class="py-4 px-6">Categoria</th>
                <th class="py-4 px-6 text-center">Tipo</th>
                <th class="py-4 px-6 text-right">Qtd</th>
                <th class="py-4 px-6">Motivo</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {movimentacoes && movimentacoes.length > 0 ? (
                movimentacoes.map((m) => {
                  const produto = produtosMap[m.produto_id] || {};
                  // Busca o nome do cliente usando o ID salvo na movimenta√ß√£o
                  const nomeCliente = clientesMap[m.cliente_id] || '-';
                  
                  return (
                    <tr class="hover:bg-gray-50 transition">
                      <td class="py-4 px-6 whitespace-nowrap font-mono text-gray-500">{formatDate(m.data_movimentacao)}</td>
                      <td class="py-4 px-6 font-bold text-gray-900">{produto.nome || 'Produto Removido'}</td>
                      <td class="py-4 px-6 text-gray-800 font-medium">{nomeCliente}</td> <td class="py-4 px-6 text-gray-500">{produto.categoria || '-'}</td>
                      <td class="py-4 px-6 text-center">
                        <span class={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide border ${
                          m.tipo === 'entrada' 
                            ? 'bg-green-100 text-green-700 border-green-200' 
                            : 'bg-red-100 text-red-700 border-red-200'
                        }`}>
                          {m.tipo}
                        </span>
                      </td>
                      <td class="py-4 px-6 text-right font-bold text-gray-800">
                        {m.tipo === 'entrada' ? '+' : '-'}{m.quantidade}
                      </td>
                      <td class="py-4 px-6 text-gray-500 italic truncate max-w-xs">{m.motivo || '-'}</td>
                    </tr>
                  );
                })
              ) : (
                <tr>
                  <td colspan="7" class="py-12 text-center text-gray-400">
                    Nenhum registro encontrado no hist√≥rico.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    import { jsPDF } from "jspdf";
    import autoTable from 'jspdf-autotable';
    import * as XLSX from 'xlsx';

    // PDF Export
    document.getElementById('btnPDF')?.addEventListener('click', () => {
      const doc = new jsPDF();
      
      doc.text("Relat√≥rio de Movimenta√ß√µes - EstoquePro", 14, 15);
      doc.setFontSize(10);
      doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 22);

      autoTable(doc, {
        html: '#tabela-relatorio',
        startY: 30,
        theme: 'grid',
        styles: { fontSize: 8 },
        headStyles: { fillColor: [66, 133, 244] } // Azul Google
      });

      doc.save('relatorio-estoque.pdf');
    });

    // Excel Export
    document.getElementById('btnExcel')?.addEventListener('click', () => {
      const table = document.getElementById('tabela-relatorio');
      const wb = XLSX.utils.table_to_book(table, { sheet: "Movimenta√ß√µes" });
      XLSX.writeFile(wb, 'relatorio-estoque.xlsx');
    });
  </script>
</Layout>