---
import Layout from '../../../layouts/Layout.astro';
import { supabase } from '$lib/supabase';
import Navbar from '../../../components/Navbar.astro';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

const currentPath = Astro.url.pathname;
const userRole = user.profile?.role ?? 'Visitante';
const podeExcluirItem = ['admin', 'Administrador'].includes(userRole);

let errorMessage = null;
let successMessage = null;

const { id: itemId } = Astro.params;
let produto = null;

// Busca o item pelo ID
if (itemId) {
  const { data, error } = await supabase
    .from('produtos')
    .select('id, nome, categoria, estoque_atual, estoque_minimo, unidade_medida')
    .eq('id', itemId)
    .single();
  produto = data;
  if (error) errorMessage = 'Item não encontrado para exclusão.';
}

if (Astro.request.method === 'POST' && podeExcluirItem && produto) {
  try {
    const formData = await Astro.request.formData();
    const senha = formData.get('senha')?.toString() ?? '';
    if (!senha || senha !== 'Admin@123') {
      throw new Error('Senha administrativa inválida!');
    }
    const { error } = await supabase
      .from('produtos')
      .delete()
      .eq('id', itemId);
    if (error) throw error;
    successMessage = 'Item excluído com sucesso!';
  } catch (error) {
    errorMessage = `Erro ao excluir: ${error.message}`;
  }
}
---

<Layout title="Excluir Item" user={user}>
  <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50">
      <div class="px-6 py-4">
        <div class="flex items-center gap-8">
          <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
            EstoquePro
          </h1>
          <Navbar user={user} currentPath={currentPath} />
        </div>
      </div>
    </header>

    <main class="p-6">
      <div class="max-w-2xl mx-auto">

        <a href="/itens" class="mb-6 inline-flex items-center gap-2 text-blue-700 hover:underline text-sm px-3 py-1 rounded border border-blue-100 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7.05 9l5.657-5.657a1 1 0 011.415 1.415L9.928 10l4.192 4.243a1 1 0 01-1.415 1.415L7.05 11H4a1 1 0 110-2h3.05z"/></svg>
          Voltar para Itens
        </a>

        <h2 class="text-2xl font-bold text-gray-900 mb-6">Excluir Item do Estoque</h2>

        {errorMessage && (
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6 flex items-center gap-2" role="alert">
            <svg class="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M18.364 5.636l-1.414 1.414L12 12l-4.95-4.95L5.636 7.05 12 13.414l6.364-6.364z" />
            </svg>
            <span>{errorMessage}</span>
          </div>
        )}

        {successMessage && (
          <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-6 flex items-center gap-2" role="alert">
            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8.007 8.007a1 1 0 01-1.414 0L3.293 10.707a1 1 0 111.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span>{successMessage}</span>
          </div>
        )}

        {podeExcluirItem && produto && !successMessage && (
          <form method="POST" class="bg-white rounded-2xl border border-gray-200 p-8 space-y-6">
            <div>
              <p class="mb-4 text-lg">
                Tem certeza que deseja <span class="text-red-600 font-semibold">excluir permanentemente</span> o item <span class="font-bold">{produto.nome}</span>?
              </p>
              <p class="mb-2 text-gray-700">
                <b>Categoria:</b> {produto.categoria} <br />
                <b>Estoque Atual:</b> {produto.estoque_atual} {produto.unidade_medida || ''} <br />
                <b>Estoque Mínimo:</b> {produto.estoque_minimo}
              </p>
              <label for="senha" class="block text-sm font-medium text-gray-700 mb-1">
                Confirme com a senha de administrador:
              </label>
              <input type="password" name="senha" id="senha" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:outline-none" />
            </div>
            <div class="flex justify-end gap-4 pt-6 border-t border-gray-200">
              <a href="/itens" class="bg-gray-100 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-200 transition">Cancelar</a>
              <button type="submit" class="bg-red-600 text-white px-6 py-3 rounded-xl hover:bg-red-700 transition">Excluir Item</button>
            </div>
          </form>
        )}


                {!podeExcluirItem && (
          <div class="text-center mt-12 bg-yellow-100 text-yellow-800 border border-yellow-300 px-4 py-6 rounded-xl">
            Você não tem permissão para excluir itens.
          </div>
        )}
      </div>
    </main>
  </div>
</Layout>


