---
// src/components/Header.astro
const { user } = Astro.props;

// Lógica de dados do usuário
const userName = user?.profile?.name ?? 'Usuário';
const userRole = user?.profile?.role ?? 'Visitante';
const userAvatar = userName.charAt(0).toUpperCase() || '#';

// Lógica de Permissões para o Menu
const canSeeItens = ['admin', 'Estoquista_Entrada', 'Estoquista_Saida'].includes(userRole);
const canSeeClientes = ['admin', 'Estoquista_Saida', 'estoquista_entrada'].includes(userRole);
const canSeeEntrada = ['admin', 'estoquista_entrada'].includes(userRole);
const canSeeSaida = ['admin', 'Estoquista_Saida'].includes(userRole);
const canSeeRelatorios = ['admin'].includes(userRole);
const canSeeImportacao = ['admin'].includes(userRole);
const canSeeConfig = ['admin'].includes(userRole);

const currentPath = new URL(Astro.request.url).pathname;
---

<header class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50 w-full">
  <div class="max-w-7xl mx-auto px-6 py-4">
    <div class="flex items-center justify-between">
      
      <div class="flex items-center gap-8">
        <a href="/dashboard" class="flex-shrink-0 hover:opacity-80 transition">
           <img src="https://i.ibb.co/1Gvrbvk7/ESTOQUE.png" alt="EstoquePro Logo" class="h-16 w-auto" />
        </a>
        
        <nav class="flex items-center gap-1 bg-white/50 rounded-2xl border border-gray-200 p-1 shadow-sm">
          
          {() => {
            const isActive = (path) => currentPath.startsWith(path) 
              ? 'bg-blue-50 text-blue-600' 
              : 'text-gray-600 hover:bg-gray-50';
            
             // Dashboard é exceção pois é a raiz
            const isDashActive = currentPath === '/dashboard' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50';

            return (
              <>
                <a href="/dashboard" class={`px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 ${isDashActive}`}>
                  <span>Dashboard</span>
                </a>
                
                {canSeeItens && (
                  <a href="/itens" class={`px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 ${isActive('/itens')}`}>
                    <span>Itens</span>
                  </a>
                )}

                {canSeeClientes && (
                  <a href="/clientes" class={`px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 ${isActive('/clientes')}`}>
                    <span>Clientes</span>
                  </a>
                )}
                
                {canSeeEntrada && (
                  <a href="/entrada" class={`px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 ${isActive('/entrada')}`}>
                    <span>Entrada</span>
                  </a>
                )}
                
                {canSeeSaida && (
                  <a href="/saida" class={`px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 ${isActive('/saida')}`}>
                    <span>Saída</span>
                  </a>
                )}
                
                {canSeeRelatorios && (
                  <a href="/relatorios" class={`px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 ${isActive('/relatorios')}`}>
                    <span>Relatórios</span>
                  </a>
                )}

                {canSeeImportacao && (
                  <a href="/importacao" class={`px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 ${isActive('/importacao')}`}>
                    <span>Importação</span>
                  </a>
                )}
                
                {canSeeConfig && (
                  <a href="/config/usuarios" class={`px-4 py-2 rounded-xl font-medium text-sm transition-all duration-300 ${isActive('/config')}`}>
                    <span>Configurações</span>
                  </a>
                )}
              </>
            )
          }}
        </nav>
      </div>

      <div class="relative" id="profile-menu-container">
        <button id="profile-menu-button" class="flex items-center gap-3 cursor-pointer">
          <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
            <span class="text-white text-sm font-medium">
              {userAvatar}
            </span>
          </div>
          <div class="hidden sm:block text-left">
            <p class="text-sm font-medium text-gray-900">{userName}</p>
            <p class="text-xs text-gray-500">{userRole}</p>
          </div>
        </button>
        
        <div id="profile-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-200 py-1 z-50">
          <div class="px-4 py-2 border-b border-gray-100">
            <p class="text-sm font-medium text-gray-900 truncate">{userName}</p>
            <p class="text-xs text-gray-500 truncate">{user.email}</p>
          </div>
          <a href="/api/auth/signout" class="flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
            <span>Sair</span>
          </a>
        </div>
      </div>

    </div>
  </div>
</header>

<script is:inline>
  function initProfileDropdown() {
    const menuButton = document.getElementById('profile-menu-button');
    const menuDropdown = document.getElementById('profile-menu-dropdown');
    const menuContainer = document.getElementById('profile-menu-container');

    if (menuButton && menuDropdown && menuContainer) {
      // Remove listeners antigos clonando o botão
      const newButton = menuButton.cloneNode(true);
      menuButton.parentNode.replaceChild(newButton, menuButton);

      newButton.addEventListener('click', () => {
        menuDropdown.classList.toggle('hidden');
      });

      document.addEventListener('click', (event) => {
        if (!menuContainer.contains(event.target)) {
          menuDropdown.classList.add('hidden');
        }
      });
    }
  }
  
  document.addEventListener('DOMContentLoaded', initProfileDropdown);
  document.addEventListener('astro:page-load', initProfileDropdown);
</script>